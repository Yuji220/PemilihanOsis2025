<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pemilihan Ketua OSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .vote-animation { animation: voteSuccess 0.6s ease-in-out; }
        @keyframes voteSuccess { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @media print { body * { visibility: hidden; } .print-area, .print-area * { visibility: visible; } .print-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none !important; } }
    </style>
</head>
<body class="gradient-bg min-h-screen">
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">üè´ Sistem Pemilihan Ketua OSIS</h1>
        <p class="text-blue-100">Pilih pemimpin masa depan sekolah kita!</p>
    </div>
    <div id="loginSection" class="max-w-md mx-auto">
        <div class="bg-white rounded-lg p-8 card-shadow">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Pemilih</h2>
            <input type="text" id="nisInput" class="border px-4 py-2 rounded w-full mb-2" placeholder="NIS (Scan Barcode)">
            <button onclick="loginVoter()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
            <div id="loginStatus" class="mt-2 text-red-600"></div>
        </div>
    </div>
    <div id="votingSection" class="hidden max-w-4xl mx-auto">
        <div class="bg-white rounded-lg p-8 card-shadow mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Pilih Kandidat Ketua OSIS</h2>
            <p class="text-gray-600 text-center mb-6">Selamat datang, <span id="voterNameDisplay" class="font-semibold text-blue-600"></span>! Pilih satu kandidat di bawah ini.</p>
            <div id="candidatesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="voteStatus" class="mt-4 text-green-600"></div>
            <button onclick="logoutVoter()" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded">Keluar / Ganti Siswa</button>
        </div>
    </div>
    <div id="resultsSection" class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg p-8 card-shadow">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìä Hasil Pemilihan Real-time</h2>
            <div id="resultsChart" class="space-y-4"></div>
            <div class="mt-6 text-center">
                <p class="text-gray-600">Total Suara: <span id="totalVotes" class="font-bold text-blue-600">0</span></p>
                <button onclick="displayResults()" class="mt-2 bg-blue-500 text-white px-4 py-1 rounded text-sm hover:bg-blue-600 transition-colors">üîÑ Refresh Hasil</button>
            </div>
        </div>
    </div>
</div>
<script>
const supabaseUrl = 'https://dgijcchxpcjprrtqunjr.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnaWpjY2h4cGNqcHJydHF1bmpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0Nzk1MjYsImV4cCI6MjA3NTA1NTUyNn0.VYQXbk0UIuinkRWnSt71J06Fqx9genWWpk0aSlF4oZ0';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let currentVoter = null;

async function loginVoter() {
    const nis = document.getElementById('nisInput').value.trim();
    if (!nis) {
        document.getElementById('loginStatus').textContent = 'NIS harus diisi!';
        return;
    }
    const { data, error } = await supabase
      .from('voters')
      .select('*')
      .eq('nis', nis)
      .single();
    if (error || !data) {
      document.getElementById('loginStatus').textContent = 'NIS tidak ditemukan!';
      return;
    }
    if (data.has_voted) {
      document.getElementById('loginStatus').textContent = 'Anda sudah melakukan voting!';
      return;
    }
    currentVoter = data;
    document.getElementById('votingSection').classList.remove('hidden');
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('voterNameDisplay').textContent = data.name;
    document.getElementById('voteStatus').textContent = '';
    await displayCandidates();
}

async function displayCandidates() {
    const { data, error } = await supabase.from('candidates').select('*');
    const container = document.getElementById('candidatesList');
    container.innerHTML = '';
    if (!data || data.length === 0) {
        container.textContent = 'Belum ada kandidat!';
        return;
    }
    data.forEach(candidate => {
        const candidateCard = document.createElement('div');
        candidateCard.className = 'bg-white rounded-lg p-6 card-shadow hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-blue-300';
        candidateCard.innerHTML = `
            <div class="text-center mb-4">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-3xl">üë§</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800">${candidate.name}</h3>
                <p class="text-gray-600">${candidate.class}</p>
            </div>
            <div class="mb-4">
                <h4 class="font-semibold text-gray-700 mb-2">Visi & Misi:</h4>
                <p class="text-sm text-gray-600">${candidate.vision}</p>
            </div>
            <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium" onclick="voteCandidate(${candidate.id})">
                Pilih ${candidate.name}
            </button>
        `;
        container.appendChild(candidateCard);
    });
}

async function voteCandidate(candidateId) {
    if (!currentVoter) return;
    await supabase.from('voters').update({ has_voted: true, voted_candidate_id: candidateId }).eq('nis', currentVoter.nis);
    const { data: candidateData } = await supabase.from('candidates').select('votes').eq('id', candidateId).single();
    if (candidateData) {
        await supabase.from('candidates').update({ votes: candidateData.votes + 1 }).eq('id', candidateId);
    }
    document.getElementById('voteStatus').textContent = 'Voting berhasil! Terima kasih.';
    setTimeout(logoutVoter, 1500);
}

function logoutVoter() {
    currentVoter = null;
    document.getElementById('votingSection').classList.add('hidden');
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('nisInput').value = '';
    document.getElementById('loginStatus').textContent = '';
}

async function displayResults() {
    const { data, error } = await supabase.from('candidates').select('*');
    const container = document.getElementById('resultsChart');
    container.innerHTML = '';
    if (!data || data.length === 0) {
        container.textContent = 'Belum ada kandidat!';
        document.getElementById('totalVotes').textContent = '0';
        return;
    }
    const totalVotes = data.reduce((sum, c) => sum + c.votes, 0);
    document.getElementById('totalVotes').textContent = totalVotes;
    data.sort((a, b) => b.votes - a.votes);
    data.forEach((candidate, idx) => {
        const percent = totalVotes > 0 ? ((candidate.votes / totalVotes) * 100).toFixed(1) : 0;
        container.innerHTML += `
            <div class="bg-white p-4 mb-2 rounded shadow">
                <div class="flex justify-between mb-2">
                    <div>
                        <span class="font-bold">${idx + 1}. ${candidate.name}</span> <span class="text-sm text-gray-600">(${candidate.class})</span>
                    </div>
                    <div>
                        <span class="font-bold text-blue-600">${candidate.votes} suara</span> <span class="text-sm text-gray-500">${percent}%</span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded h-4 mb-2"><div class="bg-blue-600 h-4 rounded" style="width: ${percent}%;"></div></div>
            </div>
        `;
    });
}

document.addEventListener('DOMContentLoaded', displayResults);
</script>
</body>
</html>
